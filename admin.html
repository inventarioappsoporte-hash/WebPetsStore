<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- v2.5 - Fix mobile filters overflow -->
    <!-- CRITICAL: Estilos inline para evitar flash de login -->
    <style id="critical-styles">
        /* Ocultar login y admin hasta que Firebase determine el estado */
        #login-screen { display: none !important; }
        #admin-layout { display: none !important; }
        /* Mostrar loading screen inmediatamente */
        #loading-screen {
            display: flex !important;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #0f172a;
            flex-direction: column;
            gap: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
        }
        #loading-screen .spinner-large {
            width: 48px;
            height: 48px;
            border: 4px solid #334155;
            border-top-color: #f97316;
            border-radius: 50%;
            animation: critical-spin 1s linear infinite;
        }
        #loading-screen .loading-text {
            color: #94a3b8;
            font-size: 0.875rem;
        }
        @keyframes critical-spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <title>${storeName}</title>
    <script>
        // Validaci√≥n de acceso con clave secreta
        (function() {
            // Permitir acceso desde localhost (vista previa local)
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' ||
                               window.location.protocol === 'file:';
            
            if (isLocalhost) return; // No validar en desarrollo local
            
            const ACCESS_KEY = 'pets2026admin';
            const params = new URLSearchParams(window.location.search);
            const key = params.get('key');
            
            // Si tiene la clave correcta, guardarla en sessionStorage
            if (key === ACCESS_KEY) {
                sessionStorage.setItem('admin_access', 'granted');
            }
            
            // Verificar acceso
            const hasAccess = sessionStorage.getItem('admin_access') === 'granted';
            if (!hasAccess) {
                // Redirigir a la tienda si no tiene acceso
                window.location.href = '/';
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; }
        :root {
            --bg: #141414;
            --bg-card: #1f1f1f;
            --bg-sidebar: #0a0a0a;
            --text: #ffffff;
            --text-muted: #a3a3a3;
            --border: #2a2a2a;
            --primary: #FF6B00;
            --secondary: #1E3A5F;
            --accent: #22C55E;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ========== LOGIN SCREEN ========== */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-sidebar) 0%, var(--bg) 100%);
        }
        .login-box {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
        }
        .login-logo {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .login-subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 0.875rem;
        }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
        }
        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,107,0,0.1);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), #e65c00);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,107,0,0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .login-error {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            color: var(--danger);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: none;
        }

        /* ========== ADMIN LAYOUT ========== */
        .admin-layout { display: none; min-height: 100vh; }
        .admin-layout.active { display: flex; }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
        }
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        .sidebar-logo {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sidebar-nav { padding: 1rem 0.75rem; flex: 1; }
        .nav-section { margin-bottom: 1.5rem; }
        .nav-section-title {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            padding: 0 0.75rem;
            margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9375rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 0.25rem;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item .icon { font-size: 1.125rem; }
        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            max-width: 100vw;
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .header-search {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg);
            padding: 0.625rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            width: 300px;
        }
        .header-search input {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 0.875rem;
            width: 100%;
        }
        .header-search input:focus { outline: none; }
        .header-search input::placeholder { color: var(--text-muted); }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .header-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            transition: all 0.15s;
        }
        .header-btn:hover { color: var(--text); border-color: var(--primary); }
        .header-btn .notification-dot {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
        }
        
        /* ========== NOTIFICATIONS DROPDOWN ========== */
        .notifications-wrapper {
            position: relative;
        }
        .notifications-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 360px;
            max-height: 480px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            overflow: hidden;
        }
        .notifications-dropdown.active { display: block; }
        .notifications-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }
        .notifications-title {
            font-weight: 600;
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .notifications-count {
            background: var(--danger);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .notifications-clear {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .notifications-clear:hover { color: var(--primary); background: rgba(255,255,255,0.05); }
        .notifications-list {
            max-height: 380px;
            overflow-y: auto;
        }
        .notification-item {
            display: flex;
            gap: 0.875rem;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }
        .notification-item:hover { background: rgba(255,255,255,0.03); }
        .notification-item:last-child { border-bottom: none; }
        .notification-item.unread { background: rgba(255,107,0,0.05); }
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .notification-icon.order { background: rgba(245,158,11,0.15); }
        .notification-icon.stock { background: rgba(239,68,68,0.15); }
        .notification-icon.success { background: rgba(34,197,94,0.15); }
        .notification-icon.info { background: rgba(59,130,246,0.15); }
        .notification-content { flex: 1; min-width: 0; }
        .notification-text {
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 0.25rem;
        }
        .notification-text strong { color: var(--primary); }
        .notification-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .notifications-empty {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
        }
        .notifications-empty-icon { font-size: 2.5rem; margin-bottom: 0.5rem; opacity: 0.5; }
        .notifications-empty-text { font-size: 0.875rem; }
        .notifications-footer {
            padding: 0.75rem 1.25rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
            text-align: center;
        }
        .notifications-footer a {
            color: var(--primary);
            font-size: 0.8125rem;
            font-weight: 500;
            text-decoration: none;
        }
        .notifications-footer a:hover { text-decoration: underline; }
        
        @media (max-width: 768px) {
            .notifications-dropdown {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-height: 70vh;
                border-radius: 16px 16px 0 0;
                animation: slideUpNotif 0.3s ease;
            }
            @keyframes slideUpNotif { from { transform: translateY(100%); } to { transform: translateY(0); } }
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .user-info { text-align: left; }
        .user-name { font-size: 0.875rem; font-weight: 600; }
        .user-role { font-size: 0.75rem; color: var(--text-muted); }

        /* ========== DASHBOARD CONTENT ========== */
        .dashboard { padding: 1.5rem; }
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        .page-title { font-size: 1.5rem; font-weight: 700; }
        .page-subtitle { color: var(--text-muted); font-size: 0.875rem; margin-top: 0.25rem; }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        .stat-card.primary::before { background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.danger::before { background: var(--danger); }
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .stat-card.primary .stat-icon { background: rgba(255,107,0,0.15); }
        .stat-card.success .stat-icon { background: rgba(34,197,94,0.15); }
        .stat-card.warning .stat-icon { background: rgba(245,158,11,0.15); }
        .stat-card.danger .stat-icon { background: rgba(239,68,68,0.15); }
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem; }
        .stat-label { color: var(--text-muted); font-size: 0.875rem; }
        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }
        .stat-change.up { background: rgba(34,197,94,0.15); color: var(--success); }
        .stat-change.down { background: rgba(239,68,68,0.15); color: var(--danger); }
        
        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }
        .chart-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }
        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .chart-title { font-size: 1rem; font-weight: 600; }
        .chart-period {
            display: flex;
            gap: 0.5rem;
        }
        .period-btn {
            padding: 0.375rem 0.75rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
        }
        .period-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        /* Donut Chart */
        .donut-chart {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        .donut-visual {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: conic-gradient(
                var(--warning) 0deg 120deg,
                var(--success) 120deg 240deg,
                var(--danger) 240deg 300deg,
                var(--info) 300deg 360deg
            );
            position: relative;
        }
        .donut-visual::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: var(--bg-card);
            border-radius: 50%;
        }
        .donut-legend { flex: 1; }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        .legend-label { flex: 1; font-size: 0.875rem; }
        .legend-value { font-weight: 600; font-size: 0.875rem; }

        /* ========== ORDERS TABLE ========== */
        .orders-section {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .orders-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        .orders-title { font-size: 1rem; font-weight: 600; }
        .orders-filters { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .orders-toolbar {
            background: var(--bg-card);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .filter-btn:hover { border-color: var(--primary); color: var(--text); }
        .filter-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        
        .orders-table { width: 100%; border-collapse: collapse; }
        .orders-table th {
            text-align: left;
            padding: 1rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }
        .orders-table td {
            padding: 1rem 1.5rem;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        .orders-table tr:hover { background: rgba(255,255,255,0.02); }
        .order-id-cell {
            font-weight: 600;
            color: var(--primary);
        }
        .customer-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .customer-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .customer-name { font-weight: 500; }
        .customer-phone { font-size: 0.75rem; color: var(--text-muted); }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-badge.pending { background: rgba(245,158,11,0.15); color: var(--warning); }
        .status-badge.confirmed { background: rgba(34,197,94,0.15); color: var(--success); }
        .status-badge.cancelled { background: rgba(239,68,68,0.15); color: var(--danger); }
        .status-badge.delivered { background: rgba(59,130,246,0.15); color: var(--info); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        
        .actions-cell { display: flex; gap: 0.5rem; }
        .action-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.15s;
        }
        .action-btn.confirm { background: rgba(34,197,94,0.15); color: var(--success); }
        .action-btn.confirm:hover { background: var(--success); color: white; }
        .action-btn.cancel { background: rgba(239,68,68,0.15); color: var(--danger); }
        .action-btn.cancel:hover { background: var(--danger); color: white; }
        .action-btn.whatsapp { background: rgba(37,211,102,0.15); color: #25d366; }
        .action-btn.whatsapp:hover { background: #25d366; color: white; }
        .action-btn.view { background: rgba(59,130,246,0.15); color: var(--info); }
        .action-btn.view:hover { background: var(--info); color: white; }
        
        /* Empty State */
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
        }
        .empty-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        .empty-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; }
        .empty-text { color: var(--text-muted); font-size: 0.875rem; }
        
        /* Loading */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            gap: 0.75rem;
            color: var(--text-muted);
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
        }
        
        /* Orders Toolbar */
        .orders-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .btn-view-all {
            background: transparent;
            border: none;
            color: var(--primary);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0.5rem;
        }
        .btn-view-all:hover { text-decoration: underline; }
        
        /* Page Content */
        .page-content { padding: 1.5rem; }
        
        /* ========== RESPONSIVE MOBILE ========== */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.open { transform: translateX(0); }
            .main-content { 
                margin-left: 0; 
                max-width: 100vw;
                overflow-x: hidden;
            }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
            .header { padding: 0.75rem 1rem; }
            .header-search { display: none; }
            .user-menu { padding: 0.375rem 0.5rem; }
            .user-info { display: none; }
            .dashboard { padding: 1rem; }
            .page-header { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .page-title { font-size: 1.25rem; }
            .stat-card { padding: 1rem; }
            .stat-icon { width: 40px; height: 40px; font-size: 1.25rem; margin-bottom: 0.75rem; }
            .stat-value { font-size: 1.5rem; }
            .stat-label { font-size: 0.75rem; }
            .charts-grid { grid-template-columns: 1fr; gap: 1rem; }
            .chart-card { padding: 1rem; }
            .orders-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; padding: 1rem; }
            .orders-toolbar {
                padding: 0.75rem;
                overflow: hidden;
            }
            .orders-filters { 
                width: 100%; 
                overflow-x: auto; 
                flex-wrap: nowrap; 
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
                gap: 0.375rem;
            }
            .filter-btn { 
                white-space: nowrap; 
                flex-shrink: 0; 
                padding: 0.375rem 0.5rem;
                font-size: 0.6875rem;
            }
            .orders-table { display: none; }
            .orders-mobile { display: block; }
            .login-box { padding: 1.5rem; margin: 1rem; }
            .login-logo { font-size: 1.5rem; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
            .stat-card { display: flex; align-items: center; gap: 1rem; padding: 0.875rem; }
            .stat-icon { margin-bottom: 0; }
            .stat-content { flex: 1; }
            .stat-value { font-size: 1.25rem; }
            .header-actions { gap: 0.5rem; }
            .header-btn { width: 36px; height: 36px; }
            .dashboard { padding: 0.75rem; }
            .page-title { font-size: 1.125rem; }
            /* Filtros ultra compactos */
            .orders-toolbar { padding: 0.75rem; }
            .filter-btn { 
                padding: 0.3rem 0.5rem;
                font-size: 0.6875rem;
                border-radius: 6px;
            }
        }
        
        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none; width: 40px; height: 40px;
            align-items: center; justify-content: center;
            background: var(--bg); border: 1px solid var(--border);
            border-radius: 10px; color: var(--text); cursor: pointer; font-size: 1.25rem;
        }
        @media (max-width: 768px) { .mobile-menu-btn { display: flex; } }
        
        /* Mobile Orders Cards */
        .orders-mobile { display: none; padding: 0.5rem; overflow-x: hidden; }
        @media (max-width: 768px) { .orders-mobile { display: block; } }
        .order-card-mobile {
            background: var(--bg); border-radius: 12px; padding: 0.75rem;
            margin-bottom: 0.625rem; border: 1px solid var(--border); overflow: hidden;
        }
        .order-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .order-card-id { font-weight: 700; color: var(--primary); font-size: 0.9375rem; }
        .order-card-date { font-size: 0.6875rem; color: var(--text-muted); }
        .order-card-customer { display: flex; align-items: center; gap: 0.625rem; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
        .order-card-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--secondary), var(--primary)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; flex-shrink: 0; }
        .order-card-info { flex: 1; min-width: 0; overflow: hidden; }
        .order-card-name { font-weight: 600; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .order-card-phone { font-size: 0.75rem; color: var(--text-muted); }
        .order-card-details { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; gap: 0.5rem; }
        .order-card-total { font-size: 1.125rem; font-weight: 700; }
        .order-card-items { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .order-card-actions { display: flex; gap: 0.375rem; flex-wrap: nowrap; overflow: hidden; }
        .order-card-actions .action-btn { flex: 0 0 38px; width: 38px; height: 38px; font-size: 0.9375rem; min-width: unset; }
        .order-card-actions .action-btn:last-child { flex: 1; width: auto; }
        
        /* Sidebar Overlay */
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .sidebar-overlay.active { display: block; }
        @media (min-width: 769px) { .sidebar-overlay { display: none !important; } }

        /* ========== ORDER EDIT MODAL - COMPACT ========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 0.5rem;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            width: 100%;
            max-width: 520px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }
        .modal-title { font-size: 0.9375rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .modal-close {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            background: transparent; border: none; border-radius: 6px;
            color: var(--text-muted); cursor: pointer; font-size: 1rem;
        }
        .modal-close:hover { background: var(--danger); color: white; }
        .modal-body { padding: 0.75rem 1rem; overflow-y: auto; flex: 1; }
        .modal-info-row { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .modal-info-chip {
            background: var(--bg); padding: 0.375rem 0.625rem; border-radius: 6px;
            font-size: 0.75rem; border: 1px solid var(--border);
            display: flex; align-items: center; gap: 0.375rem;
        }
        .modal-info-chip .label { color: var(--text-muted); }
        .modal-info-chip .value { font-weight: 600; }
        .modal-status-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; }
        .modal-status-row label { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; }
        .modal-status-select {
            flex: 1; padding: 0.5rem 0.75rem; background: var(--bg);
            border: 1px solid var(--border); border-radius: 6px;
            color: var(--text); font-size: 0.8125rem; cursor: pointer;
        }
        .modal-status-select:focus { outline: none; border-color: var(--primary); }
        .adjusted-badge {
            background: rgba(245,158,11,0.15); color: #f59e0b;
            padding: 0.125rem 0.375rem; border-radius: 4px;
            font-size: 0.6875rem; font-weight: 600;
        }
        .modal-section-title {
            font-size: 0.6875rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 0.375rem;
        }
        .order-items-compact {
            background: var(--bg); border-radius: 8px; border: 1px solid var(--border);
            max-height: 180px; overflow-y: auto;
        }
        .order-item-compact {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem; border-bottom: 1px solid var(--border); font-size: 0.75rem;
        }
        .order-item-compact:last-child { border-bottom: none; }
        .order-item-compact img { width: 32px; height: 32px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .order-item-compact .item-info { flex: 1; min-width: 0; }
        .order-item-compact .item-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .order-item-compact .item-variant { font-size: 0.625rem; color: var(--text-muted); }
        .order-item-compact .item-price { color: var(--text-muted); font-size: 0.6875rem; width: 55px; text-align: right; flex-shrink: 0; }
        .order-item-compact .item-qty {
            width: 40px; padding: 0.25rem; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: 4px;
            color: var(--text); text-align: center; font-size: 0.75rem; flex-shrink: 0;
        }
        .order-item-compact .item-qty:focus { outline: none; border-color: var(--primary); }
        .order-item-compact .item-subtotal { font-weight: 600; color: var(--primary); width: 60px; text-align: right; flex-shrink: 0; }
        .order-item-compact .item-remove {
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            background: rgba(239,68,68,0.1); border: none; border-radius: 4px;
            color: #ef4444; cursor: pointer; font-size: 0.75rem; flex-shrink: 0;
        }
        .order-item-compact .item-remove:hover { background: #ef4444; color: white; }
        .modal-totals-compact {
            display: flex; justify-content: flex-end; gap: 1rem;
            padding: 0.5rem 0; margin-top: 0.5rem; border-top: 1px solid var(--border); font-size: 0.75rem;
        }
        .modal-totals-compact .total-item { display: flex; gap: 0.375rem; }
        .modal-totals-compact .total-label { color: var(--text-muted); }
        .modal-totals-compact .total-value { font-weight: 600; }
        .modal-totals-compact .total-final { font-size: 0.875rem; color: var(--primary); }
        .modal-notes-compact { margin-top: 0.75rem; }
        .modal-textarea {
            width: 100%; padding: 0.5rem; background: var(--bg);
            border: 1px solid var(--border); border-radius: 6px;
            color: var(--text); font-size: 0.75rem; resize: none; height: 50px; font-family: inherit;
        }
        .modal-textarea:focus { outline: none; border-color: var(--primary); }
        .modal-textarea::placeholder { color: var(--text-muted); }
        .modal-footer {
            display: flex; gap: 0.5rem; padding: 0.75rem 1rem;
            border-top: 1px solid var(--border); background: var(--bg);
        }
        .modal-btn {
            flex: 1; padding: 0.5rem 0.75rem; border: none; border-radius: 6px;
            font-size: 0.75rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 0.375rem;
        }
        .modal-btn-save { background: linear-gradient(135deg, var(--primary), #e65c00); color: white; }
        .modal-btn-save:hover { opacity: 0.9; }
        .modal-btn-whatsapp { background: #25d366; color: white; }
        .modal-btn-whatsapp:hover { background: #20bd5a; }
        .modal-btn-cancel { background: var(--bg-card); color: var(--text-muted); border: 1px solid var(--border); }
        .modal-btn-cancel:hover { color: var(--text); }
        .modal-btn-receipt { background: #3b82f6; color: white; }
        .modal-btn-receipt:hover { background: #2563eb; }
        .modal-btn-add { background: rgba(34,197,94,0.15); color: var(--success); border: 1px dashed var(--success); }
        .modal-btn-add:hover { background: var(--success); color: white; }
        
        /* Add Product Search */
        .add-product-section { margin-top: 0.5rem; display: none; }
        .add-product-section.active { display: block; }
        .add-product-search {
            display: flex; gap: 0.5rem; margin-bottom: 0.5rem;
        }
        .add-product-search input {
            flex: 1; padding: 0.5rem; background: var(--bg);
            border: 1px solid var(--border); border-radius: 6px;
            color: var(--text); font-size: 0.75rem;
        }
        .add-product-search input:focus { outline: none; border-color: var(--primary); }
        .add-product-results {
            background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
            max-height: 150px; overflow-y: auto;
        }
        .add-product-item {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem; border-bottom: 1px solid var(--border);
            cursor: pointer; font-size: 0.75rem;
        }
        .add-product-item:last-child { border-bottom: none; }
        .add-product-item:hover { background: rgba(255,107,0,0.1); }
        .add-product-item img { width: 32px; height: 32px; object-fit: cover; border-radius: 4px; }
        .add-product-item .product-info { flex: 1; }
        .add-product-item .product-name { font-weight: 500; }
        .add-product-item .product-price { color: var(--primary); font-weight: 600; }
        
        /* Item status badges */
        .item-status-badge {
            font-size: 0.5rem; padding: 0.125rem 0.25rem; border-radius: 3px;
            font-weight: 600; margin-left: 0.25rem;
        }
        .item-status-badge.replaced { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .item-status-badge.added { background: rgba(34,197,94,0.15); color: #22c55e; }
        .item-status-badge.removed { background: rgba(239,68,68,0.15); color: #ef4444; text-decoration: line-through; }
        
        /* Price edit */
        .item-price-edit {
            width: 55px; padding: 0.125rem 0.25rem; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: 3px;
            color: var(--text); text-align: right; font-size: 0.6875rem;
        }
        .item-price-edit:focus { outline: none; border-color: var(--primary); }
        
        /* Modal Responsive */
        @media (max-width: 768px) {
            .modal-overlay { padding: 0; align-items: flex-end; }
            .modal-content { max-width: 100%; width: 100%; max-height: 92vh; border-radius: 16px 16px 0 0; animation: slideUp 0.3s ease; overflow: hidden; }
            @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
            .modal-header { padding: 0.75rem 1rem; }
            .modal-title { font-size: 0.875rem; }
            .modal-close { width: 32px; height: 32px; font-size: 1.125rem; }
            .modal-body { padding: 0.75rem; overflow-x: hidden; overflow-y: auto; }
            .modal-info-row { flex-direction: column; gap: 0.25rem; margin-bottom: 0.5rem; }
            .modal-info-chip { width: 100%; justify-content: space-between; padding: 0.5rem 0.625rem; font-size: 0.8125rem; }
            .modal-info-chip .label { flex-shrink: 0; margin-right: 0.5rem; }
            .modal-info-chip .value { text-align: right; word-break: break-word; overflow: hidden; text-overflow: ellipsis; }
            .modal-status-row { flex-direction: column; align-items: stretch; gap: 0.25rem; margin-bottom: 0.5rem; }
            .modal-status-select { padding: 0.625rem; font-size: 0.9375rem; }
            .modal-section-title { font-size: 0.6875rem; margin-top: 0.375rem; margin-bottom: 0.375rem; }
            .order-items-compact { max-height: 30vh; overflow-x: hidden; }
            .order-item-compact { display: flex; flex-wrap: wrap; gap: 0.375rem; padding: 0.5rem; align-items: center; }
            .order-item-compact img { width: 36px; height: 36px; flex-shrink: 0; border-radius: 4px; }
            .order-item-compact .item-info { flex: 1; min-width: 0; }
            .order-item-compact .item-name { font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .order-item-compact .item-variant { font-size: 0.625rem; }
            .order-item-compact .item-remove { width: 24px; height: 24px; flex-shrink: 0; }
            .order-item-compact .item-price { display: none; }
            .order-item-compact .item-qty { width: 32px; padding: 0.25rem; font-size: 0.8125rem; }
            .order-item-compact .item-subtotal { font-size: 0.8125rem; flex-shrink: 0; }
            .modal-totals-compact { flex-direction: column; gap: 0.25rem; align-items: stretch; padding: 0.5rem 0; margin-top: 0.25rem; }
            .modal-totals-compact .total-item { justify-content: space-between; font-size: 0.8125rem; }
            .modal-totals-compact .total-final { font-size: 1rem; }
            .modal-notes-compact { margin-top: 0.375rem; }
            .modal-textarea { height: 40px; font-size: 0.8125rem; padding: 0.5rem; }
            .modal-footer { padding: 0.625rem; gap: 0.375rem; flex-wrap: nowrap; }
            .modal-btn { padding: 0.625rem 0.5rem; font-size: 0.75rem; min-height: 40px; flex: 1; }
            .modal-btn-save { flex: 2; }
            .modal-btn-cancel { flex: 0 0 40px; padding: 0; }
            .modal-btn-whatsapp { flex: 0 0 40px; padding: 0; }
        }
        @media (max-width: 380px) {
            .modal-content { max-height: 95vh; }
            .modal-body { padding: 0.5rem; }
            .modal-info-chip { padding: 0.375rem 0.5rem; font-size: 0.75rem; }
            .order-items-compact { max-height: 25vh; }
            .order-item-compact { padding: 0.375rem; }
            .order-item-compact img { width: 32px; height: 32px; }
            .order-item-compact .item-name { font-size: 0.6875rem; }
            .modal-footer { padding: 0.5rem; }
            .modal-btn { font-size: 0.6875rem; min-height: 36px; }
        }
        
        /* Loading Screen */
        .loading-screen {
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; background: var(--bg); flex-direction: column; gap: 1rem;
        }
        .loading-screen .spinner-large { width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        .loading-screen .loading-text { color: var(--text-muted); font-size: 0.875rem; }

        /* ========== INVENTORY STYLES ========== */
        .inventory-search-input {
            padding: 0.5rem 1rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.875rem;
            width: 250px;
        }
        .inventory-search-input:focus { outline: none; border-color: var(--primary); }
        .inventory-filter-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .inventory-filter-btn:hover { border-color: var(--primary); color: var(--text); }
        .inventory-filter-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .inventory-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.15s;
        }
        .inventory-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .inventory-card.out-of-stock { border-color: var(--danger); background: rgba(239,68,68,0.05); }
        .inventory-card.low-stock { border-color: var(--warning); background: rgba(245,158,11,0.05); }
        .inventory-card-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg);
        }
        .inventory-card-info { flex: 1; min-width: 0; }
        .inventory-card-name {
            font-weight: 600;
            font-size: 0.9375rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .inventory-card-variant {
            font-size: 0.75rem;
            color: var(--primary);
            margin-top: 0.125rem;
        }
        .inventory-card-category {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        .inventory-card-stock { text-align: center; }
        .stock-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .stock-value.ok { color: var(--success); }
        .stock-value.low { color: var(--warning); }
        .stock-value.out { color: var(--danger); }
        .stock-controls { display: flex; gap: 0.25rem; }
        .stock-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .stock-btn:hover { border-color: var(--primary); background: var(--primary); color: white; }
        .stock-btn.minus:hover { background: var(--danger); border-color: var(--danger); }
        .stock-btn.plus:hover { background: var(--success); border-color: var(--success); }
        @media (max-width: 768px) {
            .inventory-search-input { width: 100%; margin-top: 0.5rem; }
            .inventory-grid { grid-template-columns: 1fr; }
            .inventory-card { 
                padding: 0.75rem;
                flex-wrap: nowrap;
            }
            .inventory-card-image { width: 50px; height: 50px; flex-shrink: 0; }
            .inventory-card-info { 
                flex: 1; 
                min-width: 0;
                margin-right: 0.5rem;
            }
            .inventory-card-name { 
                font-size: 0.8125rem;
                white-space: normal;
                overflow: hidden;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                line-height: 1.3;
            }
            .inventory-card-variant { font-size: 0.6875rem; }
            .inventory-card-category { font-size: 0.625rem; }
            .inventory-card-stock {
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-width: 70px;
            }
            .stock-value { font-size: 1.25rem; margin-bottom: 0.25rem; }
            .stock-controls { display: flex; gap: 0.25rem; }
            .stock-btn { width: 28px; height: 28px; font-size: 1rem; }
        }
    </style>
</head>
<body>

    <!-- ========== LOADING SCREEN ========== -->
    <div class="loading-screen" id="loading-screen">
        <div class="spinner-large"></div>
        <div class="loading-text">Verificando sesi√≥n...</div>
    </div>

    <!-- ========== LOGIN SCREEN ========== -->
    <div class="login-screen" id="login-screen" style="display: none;">
        <div class="login-box">
            <div class="login-logo">Pets Store Admin</div>
            <div class="login-subtitle">Panel de Administraci√≥n</div>
            <div class="login-error" id="login-error"></div>
            <form id="login-form">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" required placeholder="admin@tienda.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="login-btn">
                    <span>Iniciar Sesi√≥n</span>
                </button>
            </form>
        </div>
    </div>

    <!-- ========== ADMIN LAYOUT ========== -->
    <div class="admin-layout" id="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span>üêæ</span>
                    <span>Pets Store Admin</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <div class="nav-item active" data-page="dashboard">
                        <span class="icon">üìä</span>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-page="orders">
                        <span class="icon">üì¶</span>
                        <span>Pedidos</span>
                        <span class="badge" id="nav-pending-badge">0</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Gesti√≥n</div>
                    <div class="nav-item" data-page="inventory">
                        <span class="icon">üìä</span>
                        <span>Inventario</span>
                    </div>
                    <div class="nav-item disabled" title="Pr√≥ximamente">
                        <span class="icon">üí∞</span>
                        <span>Precios</span>
                    </div>
                </div>
            </nav>
        </aside>
        
        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <button class="mobile-menu-btn" id="mobile-menu-btn" title="Men√∫">‚ò∞</button>
                <div class="header-search">
                    <span>üîç</span>
                    <input type="text" placeholder="Buscar pedidos, clientes..." id="search-input">
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="refresh-btn" title="Actualizar">
                        üîÑ
                    </button>
                    <div class="notifications-wrapper">
                        <button class="header-btn" id="notifications-btn">
                            üîî
                            <span class="notification-dot" id="notification-dot" style="display:none;"></span>
                        </button>
                        <div class="notifications-dropdown" id="notifications-dropdown">
                            <div class="notifications-header">
                                <div class="notifications-title">
                                    üîî Notificaciones
                                    <span class="notifications-count" id="notifications-count">0</span>
                                </div>
                                <button class="notifications-clear" onclick="clearNotifications()">Marcar le√≠das</button>
                            </div>
                            <div class="notifications-list" id="notifications-list">
                                <div class="notifications-empty">
                                    <div class="notifications-empty-icon">üîï</div>
                                    <div class="notifications-empty-text">No hay notificaciones</div>
                                </div>
                            </div>
                            <div class="notifications-footer">
                                <a href="#" onclick="showPage('orders'); toggleNotifications(); return false;">Ver todos los pedidos ‚Üí</a>
                            </div>
                        </div>
                    </div>
                    <div class="user-menu" id="user-menu">
                        <div class="user-avatar" id="user-avatar">A</div>
                        <div class="user-info">
                            <div class="user-name" id="user-name">Admin</div>
                            <div class="user-role">Administrador</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Page -->
            <div class="dashboard" id="page-dashboard">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">Resumen de tu tienda en tiempo real</p>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-value" id="stat-orders-today">0</div>
                        <div class="stat-label">Pedidos Hoy</div>
                        <div class="stat-change up" id="stat-orders-change">‚Üë 0%</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="stat-sales-today">$0</div>
                        <div class="stat-label">Ventas del D√≠a</div>
                        <div class="stat-change up" id="stat-sales-change">‚Üë 0%</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-value" id="stat-pending">0</div>
                        <div class="stat-label">Pedidos Pendientes</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-value" id="stat-low-stock">0</div>
                        <div class="stat-label">Sin Stock</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">üìà Ventas de la Semana</div>
                            <div class="chart-period">
                                <button class="period-btn active" onclick="updateSalesChart(7)">7D</button>
                                <button class="period-btn" onclick="updateSalesChart(30)">30D</button>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 200px; position: relative;">
                            <canvas id="sales-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">üìä Estados de Pedidos</div>
                        </div>
                        <div class="donut-chart">
                            <div class="donut-visual"></div>
                            <div class="donut-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: var(--warning)"></div>
                                    <span class="legend-label">Pendientes</span>
                                    <span class="legend-value" id="legend-pending">0</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: var(--success)"></div>
                                    <span class="legend-label">Confirmados</span>
                                    <span class="legend-value" id="legend-confirmed">0</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: var(--danger)"></div>
                                    <span class="legend-label">Cancelados</span>
                                    <span class="legend-value" id="legend-cancelled">0</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: var(--info)"></div>
                                    <span class="legend-label">Entregados</span>
                                    <span class="legend-value" id="legend-delivered">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Orders Preview -->
                <div class="orders-section">
                    <div class="orders-header">
                        <div class="orders-title">üìã √öltimos Pedidos</div>
                        <button class="btn-view-all" onclick="showPage('orders')">Ver todos ‚Üí</button>
                    </div>
                    <div id="dashboard-orders-preview">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== ORDERS PAGE ========== -->
            <div class="dashboard" id="page-orders" style="display: none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">üì¶ Pedidos</h1>
                        <p class="page-subtitle">Gestiona todos los pedidos de tu tienda</p>
                    </div>
                </div>

                <!-- Orders Filters -->
                <div class="orders-toolbar">
                    <div class="orders-filters">
                        <button class="filter-btn active" data-filter="all">Todos</button>
                        <button class="filter-btn" data-filter="pending">‚è≥ Pendientes</button>
                        <button class="filter-btn" data-filter="confirmed">‚úÖ Confirmados</button>
                        <button class="filter-btn" data-filter="cancelled">‚ùå Cancelados</button>
                        <button class="filter-btn" data-filter="delivered">üöö Entregados</button>
                    </div>
                </div>

                <!-- Orders List -->
                <div class="orders-section">
                    <div id="orders-container">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <span>Cargando pedidos...</span>
                        </div>
                    </div>
                    <!-- Mobile Orders View -->
                    <div class="orders-mobile" id="orders-mobile-container"></div>
                </div>
            </div>

            <!-- ========== INVENTORY PAGE ========== -->
            <div class="dashboard" id="page-inventory" style="display: none;">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">üìä Inventario</h1>
                        <p class="page-subtitle">Control de stock en tiempo real</p>
                    </div>
                    <button class="btn btn-sm btn-outline" id="export-inventory-btn" onclick="exportInventory()" style="padding: 0.5rem 1rem; font-size: 0.8rem;">üì• Exportar</button>
                </div>

                <!-- Inventory Stats -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="stat-card primary">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-value" id="inv-total">0</div>
                        <div class="stat-label">Total Productos</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value" id="inv-in-stock">0</div>
                        <div class="stat-label">En Stock</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <div class="stat-value" id="inv-low-stock">0</div>
                        <div class="stat-label">Stock Bajo</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-icon">‚ùå</div>
                        <div class="stat-value" id="inv-out-stock">0</div>
                        <div class="stat-label">Sin Stock</div>
                    </div>
                </div>

                <!-- Inventory Filters -->
                <div class="orders-toolbar">
                    <div class="orders-filters">
                        <button class="inventory-filter-btn active" data-filter="all">Todos</button>
                        <button class="inventory-filter-btn" data-filter="ok">‚úÖ En Stock</button>
                        <button class="inventory-filter-btn" data-filter="low">‚ö†Ô∏è Stock Bajo</button>
                        <button class="inventory-filter-btn" data-filter="out">‚ùå Sin Stock</button>
                    </div>
                    <input type="text" id="inventory-search" placeholder="üîç Buscar producto..." class="inventory-search-input">
                </div>

                <!-- Inventory Grid -->
                <div class="inventory-grid" id="inventory-grid">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>Cargando inventario...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== ORDER EDIT MODAL ========== -->
    <div class="modal-overlay" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    üìù Pedido #<span id="modal-order-number">-</span>
                    <span class="adjusted-badge" id="modal-adjusted-badge" style="display:none;">‚ö†Ô∏è</span>
                </div>
                <button class="modal-close" onclick="closeOrderModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="modal-info-row">
                    <div class="modal-info-chip"><span class="label">üë§</span><span class="value" id="modal-customer-name">-</span></div>
                    <div class="modal-info-chip"><span class="label">üìû</span><span class="value" id="modal-customer-phone">-</span></div>
                    <div class="modal-info-chip"><span class="label">üöö</span><span class="value" id="modal-shipping-zone">-</span></div>
                </div>
                <div class="modal-status-row">
                    <label>Estado:</label>
                    <select class="modal-status-select" id="modal-order-status">
                        <option value="pending">‚è≥ Pendiente</option>
                        <option value="confirmed">‚úÖ Confirmado</option>
                        <option value="delivered">üöö Entregado</option>
                        <option value="cancelled">‚ùå Cancelado</option>
                    </select>
                </div>
                <div class="modal-section-title">üõí Productos</div>
                <div class="order-items-compact" id="modal-order-items"></div>
                <button class="modal-btn modal-btn-add" onclick="toggleAddProduct()" style="width:100%;margin-top:0.5rem;">‚ûï Agregar producto</button>
                <div class="add-product-section" id="add-product-section">
                    <div class="add-product-search">
                        <input type="text" id="add-product-input" placeholder="Buscar producto..." oninput="searchProducts(this.value)">
                    </div>
                    <div class="add-product-results" id="add-product-results"></div>
                </div>
                <div class="modal-totals-compact">
                    <div class="total-item"><span class="total-label">Subtotal:</span><span class="total-value" id="modal-subtotal">$0</span></div>
                    <div class="total-item"><span class="total-label">Env√≠o:</span><span class="total-value" id="modal-shipping-cost">$0</span></div>
                    <div class="total-item"><span class="total-label">Total:</span><span class="total-value total-final" id="modal-total">$0</span></div>
                </div>
                <div class="modal-notes-compact">
                    <textarea class="modal-textarea" id="modal-admin-notes" placeholder="Notas internas..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeOrderModal()">‚úï</button>
                <button class="modal-btn modal-btn-receipt" onclick="generateReceipt()">üßæ</button>
                <button class="modal-btn modal-btn-whatsapp" onclick="sendOrderUpdateWhatsApp()">üì±</button>
                <button class="modal-btn modal-btn-save" onclick="saveOrderChanges()">üíæ Guardar</button>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, getDocs, getDoc, deleteDoc, Timestamp, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDHWTTs1J108hiBeib4d6E5i-HLoDRoDCA",
            authDomain: "petsstore-b0516.firebaseapp.com",
            projectId: "petsstore-b0516",
            storageBucket: "petsstore-b0516.firebasestorage.app",
            messagingSenderId: "1019064151771",
            appId: "1:1019064151771:web:2d7969b48bfa8e9b7d66fe"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let ordersUnsubscribe = null;
        let currentFilter = 'all';
        let allOrders = [];

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const adminLayout = document.getElementById('admin-layout');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginBtn = document.getElementById('login-btn');

        // Auth State Observer
        onAuthStateChanged(auth, (user) => {
            console.log('Auth state changed:', user ? 'Usuario autenticado' : 'No autenticado');
            if (user) {
                currentUser = user;
                console.log('Usuario:', user.email);
                showAdmin();
                loadOrders();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        // Funci√≥n para remover estilos cr√≠ticos (permite que CSS normal tome control)
        function removeCriticalStyles() {
            const criticalStyles = document.getElementById('critical-styles');
            if (criticalStyles) {
                criticalStyles.remove();
            }
        }

        // Show Login
        function showLogin() {
            removeCriticalStyles();
            document.getElementById('loading-screen').style.display = 'none';
            loginScreen.style.display = 'flex';
            adminLayout.classList.remove('active');
            if (ordersUnsubscribe) {
                ordersUnsubscribe();
                ordersUnsubscribe = null;
            }
        }

        // Show Admin
        function showAdmin() {
            removeCriticalStyles();
            document.getElementById('loading-screen').style.display = 'none';
            loginScreen.style.display = 'none';
            adminLayout.classList.add('active');
            
            // Update user info
            const email = currentUser.email || 'admin';
            document.getElementById('user-name').textContent = email.split('@')[0];
            document.getElementById('user-avatar').textContent = email.charAt(0).toUpperCase();
        }

        // Page Navigation
        let currentPage = 'dashboard';
        
        window.showPage = function(page) {
            currentPage = page;
            
            // Hide all pages
            document.getElementById('page-dashboard').style.display = 'none';
            document.getElementById('page-orders').style.display = 'none';
            document.getElementById('page-inventory').style.display = 'none';
            
            // Show selected page
            document.getElementById('page-' + page).style.display = 'block';
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });

            // Load inventory when showing inventory page
            if (page === 'inventory' && inventoryItems.length === 0) {
                loadInventory();
            }
        };

        // Nav item click handlers
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                if (page && !item.classList.contains('disabled')) {
                    showPage(page);
                    closeMobileMenu();
                }
            });
        });
        
        // Mobile Menu Toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.querySelector('.sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        
        function openMobileMenu() {
            sidebar.classList.add('open');
            sidebarOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMobileMenu() {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        mobileMenuBtn.addEventListener('click', openMobileMenu);
        sidebarOverlay.addEventListener('click', closeMobileMenu);

        // Login Form Submit
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span>Iniciando...</span>';
            loginError.style.display = 'none';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = getErrorMessage(error.code);
                loginError.style.display = 'block';
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span>Iniciar Sesi√≥n</span>';
            }
        });

        // Get Error Message
        function getErrorMessage(code) {
            const messages = {
                'auth/invalid-email': 'Email inv√°lido',
                'auth/user-disabled': 'Usuario deshabilitado',
                'auth/user-not-found': 'Usuario no encontrado',
                'auth/wrong-password': 'Contrase√±a incorrecta',
                'auth/invalid-credential': 'Credenciales inv√°lidas',
                'auth/too-many-requests': 'Demasiados intentos. Intenta m√°s tarde.'
            };
            return messages[code] || 'Error al iniciar sesi√≥n';
        }

        // Logout
        window.logout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // User menu click
        document.getElementById('user-menu').addEventListener('click', () => {
            if (confirm('¬øCerrar sesi√≥n?')) {
                logout();
            }
        });


        // Load Orders from Firestore
        function loadOrders() {
            const STORE_ID = 'petsstore-b0516';
            console.log('Iniciando carga de pedidos...');
            
            // Mostrar estado de carga
            const dashboardPreview = document.getElementById('dashboard-orders-preview');
            if (dashboardPreview) {
                dashboardPreview.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><span>Conectando con Firebase...</span></div>';
            }
            
            // Timeout para detectar si la conexi√≥n tarda demasiado
            const loadTimeout = setTimeout(() => {
                console.warn('Timeout: La carga de pedidos est√° tardando demasiado');
                if (dashboardPreview) {
                    dashboardPreview.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--warning);">‚è≥ Conectando... Si tarda mucho, verifica tu conexi√≥n a internet.</div>';
                }
            }, 10000);
            
            try {
                const ordersRef = collection(db, 'tiendas', STORE_ID, 'orders');
                const q = query(ordersRef, orderBy('createdAt', 'desc'), limit(50));

                ordersUnsubscribe = onSnapshot(q, (snapshot) => {
                    clearTimeout(loadTimeout);
                    console.log('Snapshot recibido, documentos:', snapshot.size);
                    allOrders = [];
                    snapshot.forEach((doc) => {
                        allOrders.push({ id: doc.id, ...doc.data() });
                    });
                    console.log('Pedidos cargados:', allOrders.length);
                    
                    // Check for new orders and create notifications
                    checkNewOrders(allOrders);
                    
                    updateStats();
                    renderOrders();
                    renderDashboardPreview();
                }, (error) => {
                    clearTimeout(loadTimeout);
                    console.error('Error loading orders:', error);
                    const errorHtml = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-title">Error al cargar pedidos</div><div class="empty-text">' + error.message + '</div></div>';
                    document.getElementById('orders-container').innerHTML = errorHtml;
                    document.getElementById('dashboard-orders-preview').innerHTML = '<div style="text-align:center;padding:1rem;color:var(--danger);">‚ö†Ô∏è Error: ' + error.message + '</div>';
                });
            } catch (err) {
                clearTimeout(loadTimeout);
                console.error('Error inicializando listener:', err);
                document.getElementById('dashboard-orders-preview').innerHTML = '<div style="text-align:center;padding:1rem;color:var(--danger);">‚ö†Ô∏è Error de conexi√≥n</div>';
            }
        }

        // Update Stats
        function updateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayOrders = allOrders.filter(o => {
                const orderDate = o.createdAt?.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                return orderDate >= today;
            });

            const pending = allOrders.filter(o => o.status === 'pending').length;
            const confirmed = todayOrders.filter(o => o.status === 'confirmed').length;
            const cancelled = allOrders.filter(o => o.status === 'cancelled').length;
            const delivered = allOrders.filter(o => o.status === 'delivered').length;

            const todaySales = todayOrders
                .filter(o => o.status === 'confirmed' || o.status === 'delivered')
                .reduce((sum, o) => sum + (o.total || 0), 0);

            // Update DOM
            document.getElementById('stat-orders-today').textContent = todayOrders.length;
            document.getElementById('stat-sales-today').textContent = formatPrice(todaySales);
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-low-stock').textContent = '0';

            document.getElementById('nav-pending-badge').textContent = pending;
            document.getElementById('legend-pending').textContent = pending;
            document.getElementById('legend-confirmed').textContent = confirmed;
            document.getElementById('legend-cancelled').textContent = cancelled;
            document.getElementById('legend-delivered').textContent = delivered;

            // Notification dot
            document.getElementById('notification-dot').style.display = pending > 0 ? 'block' : 'none';
            
            // Update dashboard preview
            renderDashboardPreview();
            
            // Update sales chart
            updateSalesChart(currentChartDays);
        }
        
        // ========== SALES CHART ==========
        let salesChart = null;
        let currentChartDays = 7;
        
        window.updateSalesChart = function(days) {
            currentChartDays = days;
            
            // Update period buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === days + 'D') {
                    btn.classList.add('active');
                }
            });
            
            renderSalesChart(days);
        };
        
        function renderSalesChart(days) {
            const ctx = document.getElementById('sales-chart');
            if (!ctx) return;
            
            // Prepare data for last N days
            const labels = [];
            const salesData = [];
            const ordersData = [];
            
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                date.setHours(0, 0, 0, 0);
                
                const nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + 1);
                
                // Format label
                const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                const label = days <= 7 
                    ? dayNames[date.getDay()] 
                    : date.getDate() + '/' + (date.getMonth() + 1);
                labels.push(label);
                
                // Calculate sales for this day
                const dayOrders = allOrders.filter(o => {
                    const orderDate = o.createdAt?.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
                    return orderDate >= date && orderDate < nextDate && 
                           (o.status === 'confirmed' || o.status === 'delivered' || o.status === 'pending');
                });
                
                const daySales = dayOrders.reduce((sum, o) => sum + (o.total || 0), 0);
                salesData.push(daySales);
                ordersData.push(dayOrders.length);
            }
            
            // Destroy existing chart
            if (salesChart) {
                salesChart.destroy();
            }
            
            // Create new chart
            salesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas ($)',
                        data: salesData,
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: 'rgb(99, 102, 241)',
                        borderWidth: 1,
                        borderRadius: 6,
                        yAxisID: 'y'
                    }, {
                        label: 'Pedidos',
                        data: ordersData,
                        type: 'line',
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(34, 197, 94)',
                        tension: 0.3,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Ventas ($)') {
                                        return 'Ventas: $' + context.raw.toLocaleString('es-AR');
                                    }
                                    return 'Pedidos: ' + context.raw;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                },
                                font: { size: 10 }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: { size: 10 }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 10 }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Render Dashboard Orders Preview
        function renderDashboardPreview() {
            const container = document.getElementById('dashboard-orders-preview');
            if (!container) return;
            
            const recentOrders = allOrders.slice(0, 5);
            
            if (recentOrders.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted);"><div style="font-size:2rem;margin-bottom:0.5rem;">üì≠</div><div>No hay pedidos recientes</div><div style="font-size:0.75rem;margin-top:0.25rem;">Los pedidos aparecer√°n aqu√≠</div></div>';
                return;
            }
            
            let html = '<div style="display:flex;flex-direction:column;gap:0.5rem;padding:0.5rem;">';
            recentOrders.forEach(function(order) {
                const statusColors = { pending: '#f59e0b', confirmed: '#22c55e', cancelled: '#ef4444', delivered: '#3b82f6' };
                const statusLabels = { pending: '‚è≥ Pendiente', confirmed: '‚úÖ Confirmado', cancelled: '‚ùå Cancelado', delivered: 'üöö Entregado' };
                const color = statusColors[order.status] || '#888';
                const label = statusLabels[order.status] || order.status;
                
                html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;background:var(--bg-card);border-radius:8px;cursor:pointer;" onclick="showPage(\'orders\')">';
                html += '<div style="display:flex;flex-direction:column;gap:0.25rem;">';
                html += '<span style="font-weight:600;font-size:0.875rem;">#' + (order.orderNumber || order.id.slice(-6)) + '</span>';
                html += '<span style="font-size:0.8rem;color:var(--text-muted);">' + (order.customer?.name || order.customerName || 'Cliente') + '</span>';
                html += '</div>';
                html += '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:0.25rem;">';
                html += '<span style="font-weight:600;font-size:0.875rem;">' + formatPrice(order.total || 0) + '</span>';
                html += '<span style="font-size:0.75rem;color:' + color + ';">' + label + '</span>';
                html += '</div></div>';
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Render Orders Table
        function renderOrders() {
            const container = document.getElementById('orders-container');
            const mobileContainer = document.getElementById('orders-mobile-container');
            let filtered = allOrders;

            if (currentFilter !== 'all') {
                filtered = allOrders.filter(o => o.status === currentFilter);
            }

            if (filtered.length === 0) {
                const emptyHtml = '<div class="empty-state"><div class="empty-icon">üì≠</div><div class="empty-title">No hay pedidos</div><div class="empty-text">Los pedidos aparecer√°n aqu√≠ cuando lleguen</div></div>';
                container.innerHTML = emptyHtml;
                if (mobileContainer) mobileContainer.innerHTML = emptyHtml;
                return;
            }

            // Desktop Table View
            let html = '<table class="orders-table"><thead><tr>';
            html += '<th>Pedido</th><th>Cliente</th><th>Productos</th><th>Total</th><th>Estado</th><th>Fecha</th><th>Acciones</th>';
            html += '</tr></thead><tbody>';

            // Mobile Cards View
            let mobileHtml = '';

            filtered.forEach(order => {
                const date = order.createdAt?.toDate ? order.createdAt.toDate() : new Date(order.createdAt);
                const timeAgo = getTimeAgo(date);
                const initials = (order.customerName || 'C').substring(0, 2).toUpperCase();
                const itemsCount = order.items?.length || 0;
                const orderNum = order.orderNumber || order.id.substring(0, 6);

                // Desktop row
                html += '<tr>';
                html += '<td class="order-id-cell">#' + orderNum + '</td>';
                html += '<td><div class="customer-cell"><div class="customer-avatar">' + initials + '</div><div><div class="customer-name">' + (order.customerName || 'Cliente') + '</div><div class="customer-phone">' + (order.customerPhone || '-') + '</div></div></div></td>';
                html += '<td>' + itemsCount + ' producto' + (itemsCount !== 1 ? 's' : '') + '</td>';
                html += '<td><strong>' + formatPrice(order.total || 0) + '</strong></td>';
                html += '<td><span class="status-badge ' + order.status + '"><span class="status-dot"></span>' + getStatusLabel(order.status) + '</span></td>';
                html += '<td>' + timeAgo + '</td>';
                html += '<td class="actions-cell">';
                
                if (order.status === 'pending') {
                    html += '<button class="action-btn confirm" onclick="confirmOrder(\'' + order.id + '\')" title="Confirmar">‚úì</button>';
                    html += '<button class="action-btn cancel" onclick="cancelOrder(\'' + order.id + '\')" title="Cancelar">‚úï</button>';
                }
                if (order.status === 'cancelled') {
                    html += '<button class="action-btn delete" onclick="deleteOrder(\'' + order.id + '\')" title="Eliminar" style="background:#dc2626;">üóëÔ∏è</button>';
                }
                html += '<button class="action-btn whatsapp" onclick="sendWhatsApp(\'' + order.id + '\')" title="WhatsApp">üì±</button>';
                html += '<button class="action-btn view" onclick="viewOrder(\'' + order.id + '\')" title="Editar pedido">‚úèÔ∏è</button>';
                html += '</td></tr>';

                // Mobile card
                mobileHtml += '<div class="order-card-mobile">';
                mobileHtml += '<div class="order-card-header">';
                mobileHtml += '<span class="order-card-id">#' + orderNum + '</span>';
                mobileHtml += '<span class="order-card-date">' + timeAgo + '</span>';
                mobileHtml += '</div>';
                mobileHtml += '<div class="order-card-customer">';
                mobileHtml += '<div class="order-card-avatar">' + initials + '</div>';
                mobileHtml += '<div class="order-card-info">';
                mobileHtml += '<div class="order-card-name">' + (order.customerName || 'Cliente') + '</div>';
                mobileHtml += '<div class="order-card-phone">' + (order.customerPhone || '-') + '</div>';
                mobileHtml += '</div>';
                mobileHtml += '</div>';
                mobileHtml += '<div class="order-card-details">';
                mobileHtml += '<div><span class="order-card-total">' + formatPrice(order.total || 0) + '</span></div>';
                mobileHtml += '<div><span class="status-badge ' + order.status + '"><span class="status-dot"></span>' + getStatusLabel(order.status) + '</span></div>';
                mobileHtml += '</div>';
                mobileHtml += '<div class="order-card-items">' + itemsCount + ' producto' + (itemsCount !== 1 ? 's' : '') + '</div>';
                mobileHtml += '<div class="order-card-actions">';
                if (order.status === 'pending') {
                    mobileHtml += '<button class="action-btn confirm" onclick="confirmOrder(\'' + order.id + '\')">‚úì</button>';
                    mobileHtml += '<button class="action-btn cancel" onclick="cancelOrder(\'' + order.id + '\')">‚úï</button>';
                }
                if (order.status === 'cancelled') {
                    mobileHtml += '<button class="action-btn delete" onclick="deleteOrder(\'' + order.id + '\')" style="background:#dc2626;">üóëÔ∏è</button>';
                }
                mobileHtml += '<button class="action-btn whatsapp" onclick="sendWhatsApp(\'' + order.id + '\')">üì±</button>';
                mobileHtml += '<button class="action-btn view" onclick="viewOrder(\'' + order.id + '\')">‚úèÔ∏è</button>';
                mobileHtml += '</div></div>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            if (mobileContainer) mobileContainer.innerHTML = mobileHtml;
        }

        // Format Price
        function formatPrice(price) {
            return '$' + Number(price).toLocaleString('es-AR');
        }

        // Get Status Label
        function getStatusLabel(status) {
            const labels = { pending: 'Pendiente', confirmed: 'Confirmado', cancelled: 'Cancelado', delivered: 'Entregado' };
            return labels[status] || status;
        }

        // Get Time Ago
        function getTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'Hace ' + diff + 's';
            if (diff < 3600) return 'Hace ' + Math.floor(diff / 60) + 'm';
            if (diff < 86400) return 'Hace ' + Math.floor(diff / 3600) + 'h';
            return date.toLocaleDateString('es-AR');
        }

        // Confirm Order
        window.confirmOrder = async (orderId) => {
            if (!confirm('¬øConfirmar este pedido?')) return;
            try {
                const STORE_ID = 'petsstore-b0516';
                await updateDoc(doc(db, 'tiendas', STORE_ID, 'orders', orderId), {
                    status: 'confirmed',
                    confirmedAt: Timestamp.now()
                });
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        // Cancel Order
        window.cancelOrder = async (orderId) => {
            if (!confirm('¬øCancelar este pedido?')) return;
            try {
                const STORE_ID = 'petsstore-b0516';
                
                // Obtener el pedido para devolver el stock
                const order = allOrders.find(o => o.id === orderId);
                
                // Devolver stock de cada item
                if (order && order.items) {
                    for (const item of order.items) {
                        let inventoryId;
                        if (item.variant && item.variant.id) {
                            inventoryId = 'v_' + item.variant.id;
                        } else {
                            inventoryId = 'p_' + item.productId;
                        }
                        
                        try {
                            const inventoryRef = doc(db, 'tiendas', STORE_ID, 'inventory', inventoryId);
                            const inventoryDoc = await getDoc(inventoryRef);
                            
                            if (inventoryDoc.exists()) {
                                const currentStock = inventoryDoc.data().stock || 0;
                                const newStock = currentStock + item.quantity;
                                
                                await updateDoc(inventoryRef, {
                                    stock: newStock,
                                    updatedAt: Timestamp.now()
                                });
                                
                                console.log('üì¶ Stock devuelto: ' + inventoryId + ' - ' + currentStock + ' ‚Üí ' + newStock);
                            }
                        } catch (stockError) {
                            console.error('Error devolviendo stock:', stockError);
                        }
                    }
                }
                
                // Actualizar estado del pedido
                await updateDoc(doc(db, 'tiendas', STORE_ID, 'orders', orderId), {
                    status: 'cancelled',
                    cancelledAt: Timestamp.now()
                });
                
                console.log('‚úÖ Pedido cancelado y stock devuelto');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        // Delete Order (solo para pedidos cancelados)
        window.deleteOrder = async (orderId) => {
            if (!confirm('¬øEliminar este pedido permanentemente? Esta acci√≥n no se puede deshacer.')) return;
            try {
                const STORE_ID = 'petsstore-b0516';
                await deleteDoc(doc(db, 'tiendas', STORE_ID, 'orders', orderId));
                console.log('üóëÔ∏è Pedido eliminado: ' + orderId);
            } catch (error) {
                alert('Error al eliminar: ' + error.message);
            }
        };

        // Send WhatsApp
        window.sendWhatsApp = (orderId) => {
            const order = allOrders.find(o => o.id === orderId);
            if (!order || !order.customerPhone) {
                alert('No hay n√∫mero de tel√©fono');
                return;
            }
            const phone = order.customerPhone.replace(/\D/g, '');
            const message = 'Hola ' + (order.customerName || '') + '! Tu pedido #' + (order.orderNumber || orderId.substring(0, 6)) + ' est√° siendo procesado. Gracias por tu compra!';
            window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(message), '_blank');
        };

        // ========== ORDER EDIT MODAL FUNCTIONS ==========
        let currentEditingOrder = null;
        let editedItems = [];

        window.viewOrder = (orderId) => {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;
            
            currentEditingOrder = order;
            editedItems = JSON.parse(JSON.stringify(order.items || []));
            
            document.getElementById('modal-order-number').textContent = order.orderNumber || orderId.substring(0, 8);
            document.getElementById('modal-customer-name').textContent = order.customerName || 'Cliente';
            document.getElementById('modal-customer-phone').textContent = order.customerPhone || '-';
            document.getElementById('modal-order-status').value = order.status || 'pending';
            document.getElementById('modal-admin-notes').value = order.adminNotes || '';
            document.getElementById('modal-shipping-zone').textContent = order.shippingInfo?.zone || 'No especificado';
            document.getElementById('modal-adjusted-badge').style.display = order.wasAdjusted ? 'inline-flex' : 'none';
            
            renderModalItems();
            document.getElementById('order-modal').classList.add('active');
        };

        function renderModalItems() {
            const container = document.getElementById('modal-order-items');
            if (!editedItems.length) {
                container.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:1rem;font-size:0.75rem;">Sin productos</p>';
                updateModalTotals();
                return;
            }
            container.innerHTML = editedItems.map((item, i) => {
                const statusBadge = item.isAdded ? '<span class="item-status-badge added">NUEVO</span>' : 
                                   (item.priceAdjusted ? '<span class="item-status-badge replaced">AJUSTADO</span>' : '');
                return '<div class="order-item-compact">' +
                '<img src="' + (item.image || 'assets/images/placeholder.svg') + '" onerror="this.src=\'assets/images/placeholder.svg\'">' +
                '<div class="item-info"><div class="item-name">' + item.name + statusBadge + '</div>' +
                (item.variant ? '<div class="item-variant">' + Object.values(item.variant.attributes||{}).join(' / ') + '</div>' : '') +
                '</div>' +
                '<input type="number" class="item-price-edit" value="' + item.price + '" min="0" step="100" onchange="updateItemPrice(' + i + ', this.value)" title="Editar precio">' +
                '<input type="number" class="item-qty" value="' + item.quantity + '" min="0" onchange="updateItemQty(' + i + ', this.value)">' +
                '<div class="item-subtotal">' + formatPrice(item.price * item.quantity) + '</div>' +
                '<button class="item-remove" onclick="removeOrderItem(' + i + ')">üóëÔ∏è</button>' +
                '</div>';
            }).join('');
            updateModalTotals();
        }

        window.updateItemQty = (index, val) => {
            const qty = parseInt(val) || 0;
            if (qty <= 0) {
                if (confirm('¬øEliminar este producto?')) editedItems.splice(index, 1);
                else editedItems[index].quantity = 1;
            } else {
                editedItems[index].quantity = qty;
            }
            renderModalItems();
        };

        window.removeOrderItem = (index) => {
            if (confirm('¬øEliminar este producto?')) {
                editedItems.splice(index, 1);
                renderModalItems();
            }
        };

        function updateModalTotals() {
            const subtotal = editedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = currentEditingOrder?.shippingCost || 0;
            document.getElementById('modal-subtotal').textContent = formatPrice(subtotal);
            document.getElementById('modal-shipping-cost').textContent = formatPrice(shipping);
            document.getElementById('modal-total').textContent = formatPrice(subtotal + shipping);
        }

        window.closeOrderModal = () => {
            document.getElementById('order-modal').classList.remove('active');
            document.getElementById('add-product-section').classList.remove('active');
            document.getElementById('add-product-input').value = '';
            document.getElementById('add-product-results').innerHTML = '';
            currentEditingOrder = null;
            editedItems = [];
        };

        window.saveOrderChanges = async () => {
            if (!currentEditingOrder) return;
            const newStatus = document.getElementById('modal-order-status').value;
            const adminNotes = document.getElementById('modal-admin-notes').value;
            const newSubtotal = editedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const newTotal = newSubtotal + (currentEditingOrder.shippingCost || 0);
            const wasAdjusted = Math.abs(newTotal - (currentEditingOrder.total || 0)) > 0.01;
            
            try {
                const STORE_ID = 'petsstore-b0516';
                await updateDoc(doc(db, 'tiendas', STORE_ID, 'orders', currentEditingOrder.id), {
                    status: newStatus,
                    items: editedItems,
                    itemsCount: editedItems.length,
                    subtotal: newSubtotal,
                    total: newTotal,
                    adminNotes: adminNotes || '',
                    wasAdjusted: wasAdjusted || currentEditingOrder.wasAdjusted || false,
                    updatedAt: Timestamp.now()
                });
                alert('‚úÖ Pedido actualizado');
                closeOrderModal();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        };

        window.sendOrderUpdateWhatsApp = () => {
            if (!currentEditingOrder) return;
            const phone = (currentEditingOrder.customerPhone || '').replace(/\D/g, '');
            if (!phone) { alert('Sin tel√©fono'); return; }
            const total = editedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0) + (currentEditingOrder.shippingCost || 0);
            let msg = 'Hola ' + (currentEditingOrder.customerName || '') + '!\n\n';
            msg += 'Actualizaci√≥n de tu pedido #' + (currentEditingOrder.orderNumber || '') + ':\n\n';
            editedItems.forEach(item => { msg += '‚Ä¢ ' + item.name + ' x' + item.quantity + '\n'; });
            msg += '\nTotal: ' + formatPrice(total) + '\n\n¬°Gracias! üêæ';
            window.open('https://wa.me/' + phone + '?text=' + encodeURIComponent(msg), '_blank');
        };

        // ========== ADD PRODUCT FUNCTIONS ==========
        let allProducts = [];
        
        window.toggleAddProduct = () => {
            const section = document.getElementById('add-product-section');
            section.classList.toggle('active');
            if (section.classList.contains('active')) {
                document.getElementById('add-product-input').focus();
                loadAllProducts();
            }
        };
        
        async function loadAllProducts() {
            if (allProducts.length > 0) return;
            try {
                const response = await fetch('data/products.json');
                allProducts = await response.json();
            } catch (e) {
                console.error('Error cargando productos:', e);
            }
        }
        
        window.searchProducts = (query) => {
            const container = document.getElementById('add-product-results');
            if (!query || query.length < 2) {
                container.innerHTML = '<p style="padding:0.5rem;color:var(--text-muted);font-size:0.75rem;text-align:center;">Escrib√≠ al menos 2 caracteres...</p>';
                return;
            }
            const q = query.toLowerCase();
            const results = allProducts.filter(p => 
                p.name?.toLowerCase().includes(q) || 
                p.category?.toLowerCase().includes(q)
            ).slice(0, 10);
            
            if (!results.length) {
                container.innerHTML = '<p style="padding:0.5rem;color:var(--text-muted);font-size:0.75rem;text-align:center;">Sin resultados</p>';
                return;
            }
            
            container.innerHTML = results.map(p => {
                const hasVariants = p.variants && p.variants.length > 0;
                const price = hasVariants ? p.variants[0].price : p.price;
                const image = hasVariants ? (p.variants[0].image || p.image) : p.image;
                return '<div class="add-product-item" onclick="addProductToOrder(' + p.id + ')">' +
                    '<img src="' + (image || 'assets/images/placeholder.svg') + '" onerror="this.src=\'assets/images/placeholder.svg\'">' +
                    '<div class="product-info"><div class="product-name">' + p.name + '</div>' +
                    (hasVariants ? '<div style="font-size:0.625rem;color:var(--text-muted);">' + p.variants.length + ' variantes</div>' : '') +
                    '</div>' +
                    '<div class="product-price">' + formatPrice(price) + '</div>' +
                    '</div>';
            }).join('');
        };
        
        window.addProductToOrder = (productId) => {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;
            
            const hasVariants = product.variants && product.variants.length > 0;
            const variant = hasVariants ? product.variants[0] : null;
            const price = hasVariants ? variant.price : product.price;
            const image = hasVariants ? (variant.image || product.image) : product.image;
            
            const newItem = {
                productId: product.id,
                name: product.name,
                price: price,
                quantity: 1,
                image: image,
                isAdded: true
            };
            if (variant) {
                newItem.variant = variant;
                newItem.variantId = variant.id;
            }
            
            editedItems.push(newItem);
            renderModalItems();
            document.getElementById('add-product-section').classList.remove('active');
            document.getElementById('add-product-input').value = '';
        };
        
        window.updateItemPrice = (index, val) => {
            const price = parseFloat(val) || 0;
            if (price >= 0) {
                editedItems[index].price = price;
                editedItems[index].priceAdjusted = true;
                renderModalItems();
            }
        };

        // ========== RECEIPT GENERATION ==========
        window.generateReceipt = () => {
            if (!currentEditingOrder) return;
            
            const subtotal = editedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = currentEditingOrder.shippingCost || 0;
            const total = subtotal + shipping;
            const date = currentEditingOrder.createdAt?.toDate?.() || new Date();
            const dateStr = date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            // Crear contenido del recibo
            const receiptHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Recibo - Pedido #${currentEditingOrder.orderNumber || ''}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #333; padding-bottom: 15px; }
        .logo { font-size: 24px; font-weight: bold; color: #FF6B00; }
        .subtitle { font-size: 12px; color: #666; margin-top: 5px; }
        .order-info { margin-bottom: 15px; }
        .order-info p { font-size: 12px; margin: 3px 0; }
        .order-number { font-size: 16px; font-weight: bold; }
        .items { border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; padding: 10px 0; margin: 10px 0; }
        .item { display: flex; justify-content: space-between; font-size: 12px; margin: 5px 0; }
        .item-name { flex: 1; }
        .item-qty { width: 30px; text-align: center; }
        .item-price { width: 70px; text-align: right; }
        .totals { margin-top: 10px; }
        .total-row { display: flex; justify-content: space-between; font-size: 12px; margin: 3px 0; }
        .total-row.final { font-size: 16px; font-weight: bold; border-top: 2px solid #333; padding-top: 8px; margin-top: 8px; }
        .footer { text-align: center; margin-top: 20px; font-size: 11px; color: #666; }
        .footer p { margin: 3px 0; }
        .whatsapp-btn { display: inline-block; margin-top: 15px; padding: 10px 20px; background: #25d366; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üêæ Pets Store</div>
        <div class="subtitle">Tu tienda de mascotas</div>
    </div>
    
    <div class="order-info">
        <p class="order-number">Pedido #${currentEditingOrder.orderNumber || ''}</p>
        <p>üìÖ Fecha: ${dateStr}</p>
        <p>üë§ Cliente: ${currentEditingOrder.customerName || 'Cliente'}</p>
        <p>üìû Tel: ${currentEditingOrder.customerPhone || '-'}</p>
        <p>üöö Env√≠o: ${currentEditingOrder.shippingInfo?.zone || 'No especificado'}</p>
    </div>
    
    <div class="items">
        <div class="item" style="font-weight:bold;border-bottom:1px solid #ccc;padding-bottom:5px;margin-bottom:5px;">
            <span class="item-name">Producto</span>
            <span class="item-qty">Cant</span>
            <span class="item-price">Precio</span>
        </div>
        ${editedItems.map(item => `
        <div class="item">
            <span class="item-name">${item.name}${item.variant ? ' (' + Object.values(item.variant.attributes||{}).join('/') + ')' : ''}</span>
            <span class="item-qty">${item.quantity}</span>
            <span class="item-price">$${(item.price * item.quantity).toLocaleString('es-AR')}</span>
        </div>
        `).join('')}
    </div>
    
    <div class="totals">
        <div class="total-row"><span>Subtotal:</span><span>$${subtotal.toLocaleString('es-AR')}</span></div>
        <div class="total-row"><span>Env√≠o:</span><span>$${shipping.toLocaleString('es-AR')}</span></div>
        <div class="total-row final"><span>TOTAL:</span><span>$${total.toLocaleString('es-AR')}</span></div>
    </div>
    
    <div class="footer">
        <p>¬°Gracias por tu compra! üêæ</p>
        <p>üìß pets.store.2026@gmail.com</p>
        <p>üì± +54 9 11 5019 2474</p>
        <p>üì∏ @petsstore2026</p>
        
        <div class="no-print">
            <button onclick="window.print()" style="margin-top:15px;padding:10px 20px;background:#FF6B00;color:white;border:none;border-radius:5px;cursor:pointer;font-weight:bold;">üñ®Ô∏è Imprimir</button>
            <a href="https://wa.me/${(currentEditingOrder.customerPhone || '').replace(/\\D/g, '')}?text=${encodeURIComponent(generateReceiptText())}" target="_blank" class="whatsapp-btn">üì± Enviar por WhatsApp</a>
        </div>
    </div>
</body>
</html>`;
            
            // Abrir en nueva ventana
            const receiptWindow = window.open('', '_blank', 'width=450,height=700');
            receiptWindow.document.write(receiptHTML);
            receiptWindow.document.close();
        };
        
        function generateReceiptText() {
            const subtotal = editedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = currentEditingOrder?.shippingCost || 0;
            const total = subtotal + shipping;
            
            let text = 'üßæ *RECIBO - PETS STORE*\n';
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            text += 'üì¶ Pedido #' + (currentEditingOrder?.orderNumber || '') + '\n\n';
            text += '*PRODUCTOS:*\n';
            editedItems.forEach(item => {
                text += '‚Ä¢ ' + item.name + ' x' + item.quantity + ' = $' + (item.price * item.quantity).toLocaleString('es-AR') + '\n';
            });
            text += '\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            text += 'Subtotal: $' + subtotal.toLocaleString('es-AR') + '\n';
            text += 'Env√≠o: $' + shipping.toLocaleString('es-AR') + '\n';
            text += '*TOTAL: $' + total.toLocaleString('es-AR') + '*\n';
            text += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
            text += '¬°Gracias por tu compra! üêæ\n';
            text += 'Pets Store Argentina';
            return text;
        }

        document.getElementById('order-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeOrderModal();
        });

        // Filter Buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderOrders();
            });
        });

        // Refresh Button
        document.getElementById('refresh-btn').addEventListener('click', () => {
            if (ordersUnsubscribe) {
                ordersUnsubscribe();
            }
            loadOrders();
        });

        // ========== NOTIFICATIONS SYSTEM ==========
        let notifications = [];
        let seenOrderIds = new Set();
        
        // Toggle notifications dropdown
        window.toggleNotifications = function() {
            const dropdown = document.getElementById('notifications-dropdown');
            dropdown.classList.toggle('active');
        };
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('notifications-dropdown');
            const btn = document.getElementById('notifications-btn');
            if (dropdown && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        // Notifications button click
        document.getElementById('notifications-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleNotifications();
        });
        
        // Add notification
        function addNotification(type, title, message, orderId, orderData) {
            const notif = {
                id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                type: type,
                title: title,
                message: message,
                orderId: orderId,
                orderData: orderData,
                time: new Date(),
                read: false
            };
            notifications.unshift(notif);
            // Keep only last 20 notifications
            if (notifications.length > 20) {
                notifications = notifications.slice(0, 20);
            }
            renderNotifications();
        }
        
        // Render notifications list
        function renderNotifications() {
            const list = document.getElementById('notifications-list');
            const countEl = document.getElementById('notifications-count');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            countEl.textContent = unreadCount;
            countEl.style.display = unreadCount > 0 ? 'inline' : 'none';
            
            if (notifications.length === 0) {
                list.innerHTML = '<div class="notifications-empty"><div class="notifications-empty-icon">üîï</div><div class="notifications-empty-text">No hay notificaciones</div></div>';
                return;
            }
            
            list.innerHTML = notifications.map(notif => {
                const iconClass = notif.type === 'order' ? 'order' : (notif.type === 'stock' ? 'stock' : 'info');
                const icon = notif.type === 'order' ? 'üì¶' : (notif.type === 'stock' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è');
                const timeAgo = getTimeAgo(notif.time);
                const unreadClass = notif.read ? '' : 'unread';
                
                return '<div class="notification-item ' + unreadClass + '" onclick="handleNotificationClick(\'' + notif.id + '\')">' +
                    '<div class="notification-icon ' + iconClass + '">' + icon + '</div>' +
                    '<div class="notification-content">' +
                        '<div class="notification-text">' + notif.message + '</div>' +
                        '<div class="notification-time">' + timeAgo + '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }
        
        // Handle notification click
        window.handleNotificationClick = function(notifId) {
            const notif = notifications.find(n => n.id === notifId);
            if (!notif) return;
            
            // Mark as read
            notif.read = true;
            renderNotifications();
            
            // Navigate based on type
            if (notif.type === 'order' && notif.orderId) {
                showPage('orders');
                toggleNotifications();
                // Scroll to order or open modal
                setTimeout(() => {
                    if (notif.orderData) {
                        viewOrder(notif.orderId);
                    }
                }, 300);
            } else if (notif.type === 'stock') {
                showPage('inventory');
                toggleNotifications();
            }
        };
        
        // Clear all notifications (mark as read)
        window.clearNotifications = function() {
            notifications.forEach(n => n.read = true);
            renderNotifications();
        };
        
        // Check for new orders and create notifications
        function checkNewOrders(orders) {
            orders.forEach(order => {
                // Only notify for pending orders we haven't seen
                if (order.status === 'pending' && !seenOrderIds.has(order.id)) {
                    seenOrderIds.add(order.id);
                    
                    // Don't notify on initial load (first 5 seconds)
                    if (Date.now() - appStartTime > 5000) {
                        const orderNum = order.orderNumber || order.id.slice(-6);
                        const customerName = order.customerName || 'Cliente';
                        const total = formatPrice(order.total || 0);
                        
                        addNotification(
                            'order',
                            'Nuevo Pedido',
                            '<strong>#' + orderNum + '</strong> - ' + customerName + ' - ' + total,
                            order.id,
                            order
                        );
                        
                        // Play notification sound (optional)
                        playNotificationSound();
                    }
                }
            });
        }
        
        // Play notification sound
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.1;
                
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                // Audio not supported
            }
        }
        
        // Track app start time for initial load detection
        const appStartTime = Date.now();

        // Search
        document.getElementById('search-input').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if (!term) {
                renderOrders();
                return;
            }
            const filtered = allOrders.filter(o => 
                (o.customerName || '').toLowerCase().includes(term) ||
                (o.customerPhone || '').includes(term) ||
                (o.orderNumber || o.id).toLowerCase().includes(term)
            );
            renderFilteredOrders(filtered);
        });

        function renderFilteredOrders(orders) {
            allOrders = orders;
            renderOrders();
        }

        // ========== INVENTORY MANAGEMENT ==========
        let inventoryItems = [];
        let inventoryFilter = 'all';
        let inventoryUnsubscribe = null;

        // Load inventory from Firebase
        async function loadInventory() {
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><span>Cargando inventario...</span></div>';
            
            try {
                const STORE_ID = 'petsstore-b0516';
                
                // Unsubscribe from previous listener
                if (inventoryUnsubscribe) {
                    inventoryUnsubscribe();
                }
                
                // Subscribe to inventory changes
                const inventoryRef = collection(db, 'tiendas', STORE_ID, 'inventory');
                inventoryUnsubscribe = onSnapshot(inventoryRef, (snapshot) => {
                    inventoryItems = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderInventory();
                    updateInventoryStats();
                }, (error) => {
                    console.error('Error loading inventory:', error);
                    grid.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted);">Error al cargar inventario</div>';
                });
            } catch (error) {
                console.error('Error loading inventory:', error);
                grid.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted);">Error al cargar inventario</div>';
            }
        }

        // Render inventory grid
        function renderInventory() {
            var grid = document.getElementById('inventory-grid');
            var searchTerm = (document.getElementById('inventory-search')?.value || '').toLowerCase();
            
            var filtered = inventoryItems.filter(function(item) {
                var matchesSearch = !searchTerm || 
                    item.name.toLowerCase().includes(searchTerm) ||
                    (item.variantName || '').toLowerCase().includes(searchTerm) ||
                    (item.category || '').toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;
                
                if (inventoryFilter === 'out') return item.stock === 0;
                if (inventoryFilter === 'low') return item.stock > 0 && item.stock <= 5;
                if (inventoryFilter === 'ok') return item.stock > 5;
                return true;
            });
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted);grid-column:1/-1;">No hay productos que coincidan</div>';
                return;
            }
            
            grid.innerHTML = filtered.map(function(item) {
                var stockClass = item.stock === 0 ? 'out-of-stock' : (item.stock <= 5 ? 'low-stock' : '');
                var stockValueClass = item.stock === 0 ? 'out' : (item.stock <= 5 ? 'low' : 'ok');
                var defaultImg = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="#333" width="100" height="100"/><text x="50" y="55" text-anchor="middle" fill="#666" font-size="40">üì¶</text></svg>');
                var imgSrc = item.image || defaultImg;
                var variantHtml = item.variantName ? '<div class="inventory-card-variant">' + item.variantName + '</div>' : '';
                
                return '<div class="inventory-card ' + stockClass + '" data-id="' + item.id + '">' +
                    '<img class="inventory-card-image" src="' + imgSrc + '" alt="' + item.name + '" onerror="this.src=\'' + defaultImg + '\'">' +
                    '<div class="inventory-card-info">' +
                        '<div class="inventory-card-name">' + item.name + '</div>' +
                        variantHtml +
                        '<div class="inventory-card-category">' + (item.category || 'Sin categor√≠a') + '</div>' +
                    '</div>' +
                    '<div class="inventory-card-stock">' +
                        '<div class="stock-value ' + stockValueClass + '">' + item.stock + '</div>' +
                        '<div class="stock-controls">' +
                            '<button class="stock-btn minus" onclick="updateStock(\'' + item.id + '\', -1)">‚àí</button>' +
                            '<button class="stock-btn plus" onclick="updateStock(\'' + item.id + '\', 1)">+</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // Update inventory stats
        function updateInventoryStats() {
            var total = inventoryItems.length;
            var outOfStock = inventoryItems.filter(function(i) { return i.stock === 0; }).length;
            var lowStock = inventoryItems.filter(function(i) { return i.stock > 0 && i.stock <= 5; }).length;
            var inStock = inventoryItems.filter(function(i) { return i.stock > 5; }).length;
            
            document.getElementById('inv-total').textContent = total;
            document.getElementById('inv-in-stock').textContent = inStock;
            document.getElementById('inv-low-stock').textContent = lowStock;
            document.getElementById('inv-out-stock').textContent = outOfStock;
            
            // Update dashboard stat
            document.getElementById('stat-low-stock').textContent = outOfStock;
        }

        // Update stock for an item
        window.updateStock = async function(itemId, delta) {
            var item = inventoryItems.find(function(i) { return i.id === itemId; });
            if (!item) return;
            
            var newStock = Math.max(0, item.stock + delta);
            
            try {
                var STORE_ID = 'petsstore-b0516';
                await updateDoc(doc(db, 'tiendas', STORE_ID, 'inventory', itemId), {
                    stock: newStock,
                    updatedAt: Timestamp.now()
                });
            } catch (error) {
                alert('Error al actualizar stock: ' + error.message);
            }
        };

        // Export inventory to JSON file
        window.exportInventory = async function() {
            var btn = document.getElementById('export-inventory-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Exportando...';
            
            try {
                if (inventoryItems.length === 0) {
                    alert('No hay productos en el inventario. Espera a que se carguen los datos.');
                    return;
                }
                
                // Build export data from inventoryItems
                var exportData = {
                    exportDate: new Date().toISOString(),
                    storeId: 'petsstore-b0516',
                    totalItems: inventoryItems.length,
                    items: inventoryItems.map(function(item) {
                        return {
                            id: item.id,
                            productId: item.productId,
                            variantId: item.variantId || null,
                            name: item.name,
                            variantName: item.variantName || null,
                            stock: item.stock,
                            isVariant: item.isVariant || false
                        };
                    })
                };
                
                // Create and download file
                var dataStr = JSON.stringify(exportData, null, 2);
                var blob = new Blob([dataStr], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                var date = new Date().toISOString().slice(0, 10);
                a.href = url;
                a.download = 'inventario-firebase-' + date + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Inventario exportado: ' + inventoryItems.length + ' productos\n\nArchivo: inventario-firebase-' + date + '.json\n\nImportalo en tu Admin Local (Stock) para sincronizar.');
            } catch (error) {
                alert('Error al exportar: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üì• Exportar';
            }
        };

        // Inventory filter buttons
        document.querySelectorAll('.inventory-filter-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.inventory-filter-btn').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                inventoryFilter = btn.dataset.filter;
                renderInventory();
            });
        });

        // Inventory search
        var invSearch = document.getElementById('inventory-search');
        if (invSearch) {
            invSearch.addEventListener('input', function() {
                renderInventory();
            });
        }
    </script>
</body>
</html>